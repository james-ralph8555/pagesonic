import{c as St,a as ve,b as _t,u as xt,d as ue,o as lt,e as ht,f as Ke,g as He,F as $t}from"./vendor-DWWADxPy.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const h of l)if(h.type==="childList")for(const a of h.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function s(l){const h={};return l.integrity&&(h.integrity=l.integrity),l.referrerPolicy&&(h.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?h.credentials="include":l.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function r(l){if(l.ep)return;l.ep=!0;const h=s(l);fetch(l.href,h)}})();const de=e=>_t(()=>e());function Pt(e,t,s){let r=s.length,l=t.length,h=r,a=0,i=0,b=t[l-1].nextSibling,m=null;for(;a<l||i<h;){if(t[a]===s[i]){a++,i++;continue}for(;t[l-1]===s[h-1];)l--,h--;if(l===a){const c=h<r?i?s[i-1].nextSibling:s[h-i]:b;for(;i<h;)e.insertBefore(s[i++],c)}else if(h===i)for(;a<l;)(!m||!m.has(t[a]))&&t[a].remove(),a++;else if(t[a]===s[h-1]&&s[i]===t[l-1]){const c=t[--l].nextSibling;e.insertBefore(s[i++],t[a++].nextSibling),e.insertBefore(s[--h],c),t[l]=s[h]}else{if(!m){m=new Map;let g=i;for(;g<h;)m.set(s[g],g++)}const c=m.get(t[a]);if(c!=null)if(i<c&&c<h){let g=a,x=1,se;for(;++g<l&&g<h&&!((se=m.get(t[g]))==null||se!==c+x);)x++;if(x>c-i){const w=t[a];for(;i<c;)e.insertBefore(s[i++],w)}else e.replaceChild(s[i++],t[a++])}else a++;else t[a++].remove()}}}const pt="_$DX_DELEGATE";function Tt(e,t,s,r={}){let l;return St(h=>{l=h,t===document?e():v(t,e(),t.firstChild?null:void 0,s)},r.owner),()=>{l(),t.textContent=""}}function le(e,t,s,r){let l;const h=()=>{const i=document.createElement("template");return i.innerHTML=e,i.content.firstChild},a=()=>(l||(l=h())).cloneNode(!0);return a.cloneNode=a,a}function ct(e,t=window.document){const s=t[pt]||(t[pt]=new Set);for(let r=0,l=e.length;r<l;r++){const h=e[r];s.has(h)||(s.add(h),t.addEventListener(h,Ct))}}function Oe(e,t,s){s==null?e.removeAttribute(t):e.setAttribute(t,s)}function $e(e,t){t==null?e.removeAttribute("class"):e.className=t}function ye(e,t,s){s!=null?e.style.setProperty(t,s):e.style.removeProperty(t)}function ot(e,t,s){return xt(()=>e(t,s))}function v(e,t,s,r){if(s!==void 0&&!r&&(r=[]),typeof t!="function")return rt(e,t,r,s);ve(l=>rt(e,t(),l,s),r)}function Ct(e){let t=e.target;const s=`$$${e.type}`,r=e.target,l=e.currentTarget,h=b=>Object.defineProperty(e,"target",{configurable:!0,value:b}),a=()=>{const b=t[s];if(b&&!t.disabled){const m=t[`${s}Data`];if(m!==void 0?b.call(t,m,e):b.call(t,e),e.cancelBubble)return}return t.host&&typeof t.host!="string"&&!t.host._$host&&t.contains(e.target)&&h(t.host),!0},i=()=>{for(;a()&&(t=t._$host||t.parentNode||t.host););};if(Object.defineProperty(e,"currentTarget",{configurable:!0,get(){return t||document}}),e.composedPath){const b=e.composedPath();h(b[0]);for(let m=0;m<b.length-2&&(t=b[m],!!a());m++){if(t._$host){t=t._$host,i();break}if(t.parentNode===l)break}}else i();h(r)}function rt(e,t,s,r,l){for(;typeof s=="function";)s=s();if(t===s)return s;const h=typeof t,a=r!==void 0;if(e=a&&s[0]&&s[0].parentNode||e,h==="string"||h==="number"){if(h==="number"&&(t=t.toString(),t===s))return s;if(a){let i=s[0];i&&i.nodeType===3?i.data!==t&&(i.data=t):i=document.createTextNode(t),s=je(e,s,r,i)}else s!==""&&typeof s=="string"?s=e.firstChild.data=t:s=e.textContent=t}else if(t==null||h==="boolean")s=je(e,s,r);else{if(h==="function")return ve(()=>{let i=t();for(;typeof i=="function";)i=i();s=rt(e,i,s,r)}),()=>s;if(Array.isArray(t)){const i=[],b=s&&Array.isArray(s);if(ut(i,t,s,l))return ve(()=>s=rt(e,i,s,r,!0)),()=>s;if(i.length===0){if(s=je(e,s,r),a)return s}else b?s.length===0?mt(e,i,r):Pt(e,s,i):(s&&je(e),mt(e,i));s=i}else if(t.nodeType){if(Array.isArray(s)){if(a)return s=je(e,s,r,t);je(e,s,null,t)}else s==null||s===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);s=t}}return s}function ut(e,t,s,r){let l=!1;for(let h=0,a=t.length;h<a;h++){let i=t[h],b=s&&s[e.length],m;if(!(i==null||i===!0||i===!1))if((m=typeof i)=="object"&&i.nodeType)e.push(i);else if(Array.isArray(i))l=ut(e,i,b)||l;else if(m==="function")if(r){for(;typeof i=="function";)i=i();l=ut(e,Array.isArray(i)?i:[i],Array.isArray(b)?b:[b])||l}else e.push(i),l=!0;else{const c=String(i);b&&b.nodeType===3&&b.data===c?e.push(b):e.push(document.createTextNode(c))}}return l}function mt(e,t,s=null){for(let r=0,l=t.length;r<l;r++)e.insertBefore(t[r],s)}function je(e,t,s,r){if(s===void 0)return e.textContent="";const l=r||document.createTextNode("");if(t.length){let h=!1;for(let a=t.length-1;a>=0;a--){const i=t[a];if(l!==i){const b=i.parentNode===e;!h&&!a?b?e.replaceChild(l,i):e.insertBefore(l,s):b&&i.remove()}else h=!0}}else e.insertBefore(l,s);return[l]}const kt="modulepreload",Et=function(e){return"/"+e},vt={},at=function(t,s,r){let l=Promise.resolve();if(s&&s.length>0){let b=function(m){return Promise.all(m.map(c=>Promise.resolve(c).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),i=a?.nonce||a?.getAttribute("nonce");l=b(s.map(m=>{if(m=Et(m),m in vt)return;vt[m]=!0;const c=m.endsWith(".css"),g=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${g}`))return;const x=document.createElement("link");if(x.rel=c?"stylesheet":kt,c||(x.as="script"),x.crossOrigin="",x.href=m,i&&x.setAttribute("nonce",i),document.head.appendChild(x),c)return new Promise((se,w)=>{x.addEventListener("load",se),x.addEventListener("error",()=>w(new Error(`Unable to preload CSS for ${m}`)))})}))}function h(a){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=a,window.dispatchEvent(i),!i.defaultPrevented)throw a}return l.then(a=>{for(const i of a||[])i.status==="rejected"&&h(i.reason);return t().catch(h)})},[We,et]=ue({document:null,pages:[],currentPage:1,scale:1,isLoading:!1,error:null,pdfDoc:null}),ft=()=>({state:We,loadPDF:async a=>{et(i=>({...i,isLoading:!0,error:null}));try{const i=await at(()=>import("./pdf-Dtn41y1q.js"),[]);i.GlobalWorkerOptions.workerSrc="/pdf.worker.min.js";const b=await a.arrayBuffer(),m=await i.getDocument({data:b}).promise,g=(await m.getMetadata()).info||{},x={title:g.Title||a.name.replace(".pdf",""),author:g.Author||"",subject:g.Subject||"",keywords:g.Keywords||"",creator:g.Creator||"",producer:g.Producer||"",creationDate:g.CreationDate?new Date(g.CreationDate):void 0,modificationDate:g.ModDate?new Date(g.ModDate):void 0},se=[];for(let w=1;w<=m.numPages;w++){const j=await m.getPage(w),Z=j.getViewport({scale:1}),ie=(await j.getTextContent()).items.map(y=>y.str).join(" ");se.push({pageNumber:w,width:Z.width,height:Z.height,textContent:ie})}et({document:x,pages:se,currentPage:1,scale:1,isLoading:!1,error:null,pdfDoc:m});try{console.info("[PDF] Loaded document:",x.title||"(untitled)",`· ${se.length} pages`)}catch{}}catch(i){et(b=>({...b,isLoading:!1,error:i instanceof Error?i.message:"Failed to load PDF"}))}},getCurrentPage:async a=>{if(!We().pdfDoc)return null;try{const i=a??We().currentPage;return await We().pdfDoc.getPage(i)}catch(i){return console.error("Error getting current page:",i),null}},extractTextFromPage:async a=>{if(!We().pdfDoc)return"";try{return(await(await We().pdfDoc.getPage(a)).getTextContent()).items.map(m=>m.str).join(" ")}catch(i){return console.error("Error extracting text from page:",i),""}},getAllExtractedText:()=>We().pages.map(a=>a.textContent||"").join(`

`),setCurrentPage:a=>{et(i=>{const b=Math.max(1,Math.min(a,i.pages.length));return{...i,currentPage:b}})},setScale:a=>{et(i=>({...i,scale:Math.max(.1,Math.min(a,3))}))}}),yt=e=>{try{if(e&&e.state!=="closed")return e}catch{}return new(window.AudioContext||window.webkitAudioContext)({})},Mt=e=>{const t=new Float32Array(e.length);let s=0,r=0;for(let c=0;c<e.length;c++){let g=e[c];Number.isFinite(g)||(g=0),t[c]=g;const x=Math.abs(g);x>s&&(s=x),r+=g}if(s>2&&s<=4e4)for(let g=0;g<t.length;g++)t[g]=t[g]/32768;else if(s>1)for(let c=0;c<t.length;c++)t[c]=t[c]/s;const l=r/Math.max(1,t.length);if(Math.abs(l)>.001)for(let c=0;c<t.length;c++)t[c]-=l;const i=Math.max(1,Math.floor(48e3*5/1e3)),b=t.length,m=Math.min(i,Math.floor(b/4));for(let c=0;c<m;c++){const g=c/m;t[c]*=g;const x=b-1-c;x>=0&&(t[x]*=g)}for(let c=0;c<t.length;c++){const g=t[c];t[c]=g<-1?-1:g>1?1:g}return t},Lt=async(e,t,s)=>{const r=yt(s?.audioContext||null),l=Mt(e),h=r.createBuffer(1,l.length,t);h.getChannelData(0).set(l);const a=r.createBufferSource();return a.buffer=h,s?.playbackRate&&s.playbackRate>0&&(a.playbackRate.value=s.playbackRate),a.connect(r.destination),await r.resume().catch(()=>{}),a.start(),a.onended=()=>{try{s?.onEnded?.()}catch{}},{context:r,source:a,stop:()=>{try{a.onended=null}catch{}try{a.stop()}catch{}}}},Ft=async e=>{if(e)try{e.state==="running"&&await e.suspend()}catch{}},At=async e=>{if(e)try{e.state==="suspended"&&await e.resume()}catch{}},Vt=async e=>{if(e)try{e.state!=="closed"&&await e.close()}catch{}};function Nt(e){return e?e.replace(/[\u{1F300}-\u{1FAFF}\u{200D}\u{FE0F}]/gu,"").replace(/[""''"""]/g,"").replace(/[()\\]/g,"").replace(/\s+—\s+/g,". ").replace(/[^\u0000-\u024F.,!?;:\-\s0-9a-zA-Z]/g,"").trim():""}const[Q,K]=ue({isPlaying:!1,isPaused:!1,currentSentence:0,totalSentences:0,voice:"",rate:1,pitch:1,model:null,engine:"local",isModelLoading:!1,isWebGPUSupported:!1,lastError:null,session:void 0,systemVoices:[],chunkMaxChars:280,chunkOverlapChars:24,sentenceSplit:!0,interChunkPauseMs:120,targetSampleRate:22050}),bt=[{name:"Kokoro TTS",size:82,voices:["af_sarah","af_nicole","am_michael","bf_emma","bf_isabella"],requiresWebGPU:!0,url:"/models/kokoro-82m.onnx"},{name:"Piper TTS",size:75,voices:[],requiresWebGPU:!1,url:"/tts-model/en_US-libritts_r-medium.onnx"}],gt=()=>{globalThis.__tts_audioCtx||=null,globalThis.__tts_activeStop||=null,globalThis.__tts_stopRequested||=!1,globalThis.__piper_worker||=null,globalThis.__piper_initialized||=!1,globalThis.__piper_voiceNameToId||=null,globalThis.__piper_voiceList||=null,globalThis.__piper_pauseFn||=null,globalThis.__piper_resumeFn||=null,globalThis.__piper_isPaused||=!1;const e=()=>globalThis.__tts_audioCtx,t=o=>{globalThis.__tts_audioCtx=o},s=()=>globalThis.__tts_activeStop,r=o=>{globalThis.__tts_activeStop=o},l=()=>globalThis.__tts_stopRequested,h=o=>{globalThis.__tts_stopRequested=o},a=()=>globalThis.__piper_worker,i=o=>{globalThis.__piper_worker=o},b=()=>globalThis.__piper_initialized,m=o=>{globalThis.__piper_initialized=o},c=()=>globalThis.__piper_voiceNameToId,g=o=>{globalThis.__piper_voiceNameToId=o},x=()=>globalThis.__piper_voiceList,se=o=>{globalThis.__piper_voiceList=o},w=()=>globalThis.__piper_pauseFn,j=o=>{globalThis.__piper_pauseFn=o},Z=()=>globalThis.__piper_resumeFn,k=o=>{globalThis.__piper_resumeFn=o},ie=()=>globalThis.__piper_isPaused,y=o=>{globalThis.__piper_isPaused=o};(async()=>{try{if("gpu"in navigator&&typeof navigator.gpu<"u"){const n=!!await navigator.gpu.requestAdapter();K(d=>({...d,isWebGPUSupported:n}))}}catch(o){console.warn("WebGPU not supported:",o),K(n=>({...n,isWebGPUSupported:!1}))}})();const I=()=>{try{if("speechSynthesis"in window){const n=window.speechSynthesis.getVoices().map(d=>d.name);K(d=>{const S={...d,systemVoices:n};return d.engine==="browser"&&n.length>0&&!n.includes(d.voice)&&(S.voice=n[0]),S})}}catch{}},N=async(o=5e3)=>{if(typeof window>"u"||!("speechSynthesis"in window))return!1;if(I(),(Q().systemVoices?.length||0)>0)return!0;let n=!1;const d=()=>{n||(I(),n=(Q().systemVoices?.length||0)>0)};try{speechSynthesis.onvoiceschanged=d}catch{}try{speechSynthesis.addEventListener?.("voiceschanged",d)}catch{}try{const F=new SpeechSynthesisUtterance(".");F.volume=0,F.rate=1,F.pitch=1,F.onend=()=>{},speechSynthesis.speak(F),setTimeout(()=>{try{speechSynthesis.cancel()}catch{}},60)}catch{}try{speechSynthesis.cancel()}catch{}const S=Date.now();for(;(Q().systemVoices?.length||0)===0&&Date.now()-S<o&&(await new Promise(F=>setTimeout(F,120)),I(),!((Q().systemVoices?.length||0)>0)););try{speechSynthesis.onvoiceschanged=null}catch{}try{speechSynthesis.removeEventListener?.("voiceschanged",d)}catch{}return(Q().systemVoices?.length||0)>0},z=async()=>{if(typeof window>"u"||!("speechSynthesis"in window))return;I();const o=()=>I();try{window.speechSynthesis.onvoiceschanged=o}catch{}try{window.speechSynthesis.addEventListener?.("voiceschanged",o)}catch{}let n=0;for(;(Q().systemVoices?.length||0)===0&&n<25;)await new Promise(d=>setTimeout(d,120)),I(),n++};typeof window<"u"&&"speechSynthesis"in window&&z();const W=async()=>{if(!b())try{let o=a();o||(o=new Worker(new URL("/assets/tts.worker-BdoEGIzs.js",import.meta.url),{type:"module"}),i(o)),await new Promise((n,d)=>{if(!o)return d(new Error("Worker not created"));const S=F=>{F.data.status==="ready"?(o?.removeEventListener("message",S),n()):F.data.status==="error"&&(o?.removeEventListener("message",S),d(new Error(F.data.data)))};o.addEventListener("message",S),o.postMessage({type:"init",modelURL:"/tts-model/en_US-libritts_r-medium.onnx",cfgURL:"/tts-model/en_US-libritts_r-medium.onnx.json"})});try{let n=null,d=null;try{const S=await fetch("/tts-model/voices.json");if(S.ok){const L=(await S.json())?.["en_US-libritts_r-medium"],f=L&&L.speaker_id_map||null;if(f&&typeof f=="object"){const M=Object.entries(f);M.sort((X,O)=>X[1]-O[1]),n=M.map(([X])=>X),d=Object.fromEntries(M)}}}catch{}if(!n||!d)try{const S=await fetch("/tts-model/en_US-libritts_r-medium.onnx.json");if(S.ok){const A=(await S.json())?.speaker_id_map;if(A&&typeof A=="object"){const L=Object.entries(A);L.sort((f,M)=>f[1]-M[1]),n=L.map(([f])=>f),d=Object.fromEntries(L)}else n=["default"],d={default:0}}}catch{}n&&d&&(se(n),g(d))}catch{}m(!0),K(n=>({...n,lastError:null}))}catch(o){throw K(n=>({...n,lastError:o?.message||"Failed to initialize Piper TTS"})),o}},R=async o=>{K(n=>({...n,isModelLoading:!0,lastError:null}));try{const n=bt.find(A=>A.name===o);if(!n)throw new Error(`Model ${o} not found`);if(n.requiresWebGPU&&!Q().isWebGPUSupported)throw new Error("WebGPU required but not supported");try{if(!(await fetch(n.url,{method:"HEAD"})).ok)throw new Error(`Model file not found at ${n.url}`)}catch{throw new Error(`Model asset missing. Place file at ${n.url}`)}if(n.name==="Piper TTS"){await W();const A=x()||[],L=A.length>0?A.includes(Q().voice)?Q().voice:A[0]:Q().voice||"default",f={...n,voices:A};K(M=>({...M,model:f,engine:"local",isModelLoading:!1,lastError:null,voice:L}));return}const d=await at(()=>import("./tts-jGKqswR6.js"),[]);if(d?.env?.wasm){typeof import.meta<"u"&&!0&&(d.env.wasm.wasmPaths="/ort/");const L=globalThis.crossOriginIsolated===!0;d.env.wasm.numThreads=L?navigator.hardwareConcurrency||4:1,d.env.wasm.simd=!!L}const S=n.requiresWebGPU?["webgpu"]:["wasm"],F=await d.InferenceSession.create(n.url,{executionProviders:S});K(A=>({...A,model:n,engine:"local",isModelLoading:!1,lastError:null,session:F}))}catch(n){throw K(d=>({...d,isModelLoading:!1,lastError:n?.message||"Failed to load TTS model"})),n}},P=o=>{const n=o.replace(/\s+/g," ").split(/(?<=[.!?])\s+/).map(d=>d.trim()).filter(Boolean);return n.length>0?n:[o]},ee=o=>{const{chunkMaxChars:n,chunkOverlapChars:d,sentenceSplit:S}=Q(),F=S?P(o):[o],A=[],L=[];let f="",M=0;const X=H=>{const u=M,C=M+H.length;A.push(H),L.push({idx:A.length-1,startChar:u,endChar:C}),M=C},O=Math.max(64,Math.min(2e3,n||280)),te=Math.max(0,Math.min(200,d||0)),D=()=>{if(!f.trim())return;if(f.length<=O){X(f),f="";return}let H=0;for(;H<f.length;){const u=Math.min(f.length,H+O);let C=f.slice(H,u);if(u<f.length){const V=C.lastIndexOf(" ");V>O*.5&&(C=C.slice(0,V))}if(X(C),u>=f.length)break;const Y=Math.min(te,Math.max(0,C.length-1));H+=C.length-Y}f=""};for(const H of F)(f+(f?" ":"")+H).length>O*1.2?(D(),f=H):f=f?f+" "+H:H;return D(),{chunks:A,meta:L}},he=async(o=4e3)=>{if(typeof window>"u"||!("speechSynthesis"in window))return;const n=speechSynthesis.getVoices();n&&n.length>0||await new Promise(d=>{let S=!1;const F=()=>{S||(S=!0,d())};try{speechSynthesis.onvoiceschanged=F}catch{}try{speechSynthesis.addEventListener?.("voiceschanged",F)}catch{}const A=setTimeout(()=>{S||(S=!0,d())},o);try{speechSynthesis.cancel()}catch{}let L=0;const f=setInterval(()=>{const X=speechSynthesis.getVoices();X&&X.length>0?(clearInterval(f),F()):++L>Math.ceil(o/120)&&clearInterval(f)},120),M=()=>{try{speechSynthesis.onvoiceschanged=null}catch{}try{speechSynthesis.removeEventListener?.("voiceschanged",F)}catch{}clearTimeout(A)};Promise.resolve().then(()=>M())})},fe=async o=>{const{interChunkPauseMs:n}=Q();return new Promise((d,S)=>{const F=speechSynthesis.getVoices(),A=Q().voice?.toLowerCase?.()||"",L=F.find(te=>te.name.toLowerCase().includes(A))||F[0]||null;let f=0,M=0,X=0;const O=()=>{if(X>=o.length){f===0&&M>0?S(new Error("Browser TTS failed to synthesize speech")):d();return}const te=o[X],D=new SpeechSynthesisUtterance(te);D.rate=Q().rate,D.pitch=Q().pitch,D.voice=L,!D.lang&&L?.lang&&(D.lang=L.lang);const H=X,u=L?.name||Q().voice||"unknown";console.log(`[TTS] speak chunk ${H+1}/${o.length} (len=${te.length}) voice=${u} rate=${D.rate} pitch=${D.pitch} sr=n/a`),D.onstart=()=>{},D.onend=()=>{f+=1,X+=1,n&&n>0?setTimeout(O,n):O()},D.onerror=C=>{console.warn("[TTS] chunk error",C.error),M+=1,X+=1,O()},speechSynthesis.speak(D)};O()})},ge=()=>{K(o=>({...o,engine:"browser",model:null,session:void 0,isModelLoading:!1,lastError:null,voice:o.systemVoices&&o.systemVoices[0]?o.systemVoices[0]:o.voice}))},Se=async()=>{try{if(typeof window>"u"||!("speechSynthesis"in window))return K(n=>({...n,lastError:"SpeechSynthesis unavailable in this browser"})),!1;await N(6e3),I();const o=Q().systemVoices||[];return!o||o.length===0?(K(n=>({...n,lastError:"No SpeechSynthesis voices available. Install a system speech backend."})),!1):(K(n=>({...n,engine:"browser",model:null,session:void 0,isModelLoading:!1,lastError:null,voice:o.includes(n.voice)?n.voice:o[0]})),!0)}catch(o){return K(n=>({...n,lastError:o?.message||"Failed to enable Browser TTS"})),!1}},be=async o=>{const n=a();if(!n||!b())throw new Error("Piper TTS not initialized");const d=Nt(o);return new Promise((S,F)=>{if(!n)return F(new Error("Piper worker not initialized"));const A=[];let L=!1,f=!1,M=null;const X=()=>{try{n.removeEventListener("message",D)}catch{}try{M&&(M.onended=null,M.onerror=null,M.pause())}catch{}for(M=null;A.length>0;){const Y=A.shift();try{URL.revokeObjectURL(Y)}catch{}}r(null),j(null),k(null),y(!1)},O=()=>{f&&!L&&A.length===0&&(X(),S())},te=()=>{if(ie())return;if(l())return X(),S();if(L)return;const Y=A.shift();if(!Y)return O();L=!0;const V=new Audio(Y);M=V,r(()=>{try{V.pause()}catch{}try{V.currentTime=V.duration||0}catch{}try{URL.revokeObjectURL(Y)}catch{}}),j(()=>{y(!0);try{V.pause()}catch{}}),k(()=>{y(!1);try{M?M.play().catch(()=>{}):L||te()}catch{}}),V.onended=()=>{try{URL.revokeObjectURL(Y)}catch{}L=!1,M=null;const ne=Math.max(0,Q().interChunkPauseMs||0);ne>0?setTimeout(()=>te(),ne):te()},V.onerror=()=>{console.warn("[TTS] Piper chunk playback error");try{URL.revokeObjectURL(Y)}catch{}L=!1,M=null,te()},V.play().catch(ne=>{console.warn("[TTS] Failed to play Piper chunk:",ne),V.onerror?.(new Event("error"))})},D=Y=>{if(l())return X(),S();const V=Y.data;if(!(!V||!V.status))if(V.status==="stream")try{const ne=URL.createObjectURL(V.chunk.audio);A.push(ne),L||te()}catch(ne){console.warn("[TTS] Failed to enqueue Piper chunk:",ne)}else V.status==="complete"?(f=!0,O()):V.status==="error"&&(X(),F(new Error(String(V.data||"Piper TTS error"))))},H=c()||{},u=(Q().voice||"").trim();let C=0;if(typeof H[u]=="number")C=H[u];else{const Y=u.match(/voice\s+(\d+)/i);if(Y){const V=parseInt(Y[1]||"1",10);!Number.isNaN(V)&&V>0&&(C=V-1)}}n.addEventListener("message",D),n.postMessage({type:"generate",text:d,speakerId:C,speed:Q().rate})})};return{state:Q,models:bt,loadModel:R,selectBrowserEngine:ge,ensureBrowserEngine:Se,primeSystemVoices:N,refreshSystemVoices:I,speak:async o=>{if(typeof window<"u"&&"speechSynthesis"in window)try{speechSynthesis.cancel()}catch{}K(n=>({...n,isPlaying:!0,isPaused:!1})),h(!1);try{const n=Q(),d=performance.now(),{chunks:S,meta:F}=ee(o),A=n.engine,L=n.model?.name||"Browser TTS";if(console.log(`[TTS] text length=${o.length}, chunks=${S.length}, engine=${A}, model=${L}, voice=${n.voice}, rate=${n.rate.toFixed(2)}, pitch=${n.pitch.toFixed(2)}, targetSr=${n.targetSampleRate}`),F.forEach(f=>console.log(`[TTS] chunk #${f.idx+1} chars=[${f.startChar}, ${f.endChar})`)),n.model?.name==="Piper TTS"&&n.engine==="local"){console.log("[TTS] Speaking with Piper TTS"),await be(o);const f=performance.now();console.log(`[TTS] Piper TTS completed in ${(f-d).toFixed(0)}ms`),K(M=>({...M,isPlaying:!1,isPaused:!1}));return}if(n.model&&n.session&&n.engine==="local"&&n.model?.name!=="Piper TTS"){console.log(`[TTS] Speaking with model=${n.model.name}, voice=${n.voice}`);const f=await at(()=>import("./tts-jGKqswR6.js"),[]),M=yt(e());t(M);const X=async O=>{const te=n.session,D=te.inputMetadata||{},H=te.inputNames||Object.keys(D),u=$=>{try{const B=new TextEncoder().encode($);return Array.from(B)}catch{const B=[];for(let q=0;q<$.length;q++)B.push($.charCodeAt(q)&255);return B}},C=($,B,q)=>{const pe=($||"").toLowerCase();if(pe.includes("64")){const T=new BigInt64Array(B.map(re=>BigInt(re)));return new f.Tensor("int64",T,q)}if(pe.includes("32"))return new f.Tensor("int32",Int32Array.from(B),q);if(pe.includes("uint8")||pe.includes("ubyte")||pe==="byte")return new f.Tensor("uint8",Uint8Array.from(B),q);const J=new BigInt64Array(B.map(T=>BigInt(T)));return new f.Tensor("int64",J,q)},Y=($,B)=>{const q=($||"").toLowerCase(),pe=q.includes("int64")?"int64":q.includes("int32")?"int32":q.includes("uint8")?"uint8":q.includes("float16")?"float16":q.includes("bfloat16")?"bfloat16":q.includes("float64")||q.includes("double")?"float64":q.includes("float")?"float32":q.includes("bool")?"bool":q.includes("string")?"string":"float32",J=B&&B.length>0?B.map(re=>typeof re=="number"&&re>0?re:1):[1],T=J.reduce((re,p)=>re*p,1);switch(pe){case"int64":return new f.Tensor("int64",new BigInt64Array(T),J);case"int32":return new f.Tensor("int32",new Int32Array(T),J);case"uint8":return new f.Tensor("uint8",new Uint8Array(T),J);case"float64":return new f.Tensor("float64",new Float64Array(T),J);case"float16":return new f.Tensor("float16",new Uint16Array(T),J);case"bfloat16":return new f.Tensor("bfloat16",new Uint16Array(T),J);case"bool":return new f.Tensor("bool",new Uint8Array(T),J);case"string":return new f.Tensor("string",Array(T).fill(""),J);default:return new f.Tensor("float32",new Float32Array(T),J)}},V=()=>{const $=n.model?.voices||[],B=Math.max(0,$.indexOf(n.voice));return B<0?0:B},ne={};for(const $ of H){const B=D[$]||{type:"tensor(float)"},q=(B?.type||"").toString(),pe=q.match(/tensor\(([^)]+)\)/)?.[1]||q,J=B?.dimensions&&B.dimensions.length>0?B.dimensions.map(T=>typeof T=="number"?T:-1):[];if(/text|chars|tokens|input_ids/i.test($)){const T=(pe||"").toLowerCase();if(T.includes("string")){const re=J.length>0?J.map(p=>typeof p=="number"&&p>0?p:1):[1];ne[$]=new f.Tensor("string",Array(re.reduce((p,E)=>p*E,1)).fill("").map((p,E)=>E===0?O:""),re)}else{const re=u(O),p=J.length>0?J.map((ae,me)=>ae===-1?me===J.length-1?re.length:1:ae):[1,re.length],E=/64/.test(T)?"int64":/32|uint8|int8/.test(T)?pe:"int64";ne[$]=C(E,re,p)}continue}if(/length|len/i.test($)){const T=(/64/.test((pe||"").toLowerCase()),"int64");ne[$]=C(T,[O.length],[1]);continue}if(/speaker|voice|spk|sid/i.test($)){const T=V(),re=(/64/.test((pe||"").toLowerCase()),"int64");ne[$]=C(re,[T],[1]);continue}if(/style|cond(itioning)?|prompt|emb(edding)?/i.test($)){const T=D[$]?.dimensions||[];let re=1,p=256;if(Array.isArray(T)&&T.length>0){if(T.length>=2){re=typeof T[0]=="number"&&T[0]>0?T[0]:1;const ae=T[1];p=typeof ae=="number"&&ae>0?ae:256}else if(T.length===1){const ae=T[0],me=typeof ae=="number"&&ae>0?ae:256;re=1,p=me}}const E=[re,p];ne[$]=Y(pe||"float32",E);continue}if(/rate|speed/i.test($)){const T=Math.max(.5,Math.min(n.rate||1,2));ne[$]=new f.Tensor("float32",Float32Array.from([T]),[1]);continue}if(/pitch/i.test($)){const T=Math.max(.5,Math.min(n.pitch||1,2));ne[$]=new f.Tensor("float32",Float32Array.from([T]),[1]);continue}}for(const $ of H){if(ne[$])continue;const B=D[$]||{},q=(B?.type||"").toString(),pe=q.match(/tensor\(([^)]+)\)/)?.[1]||q;let J;B?.dimensions&&B.dimensions.length>0?J=B.dimensions.map(T=>typeof T=="number"&&T>0?T:1):/style|cond(itioning)?|prompt|emb(edding)?/i.test($)?J=[1,1]:J=[1],ne[$]=Y(pe,J)}const Pe=await te.run(ne),Ve=Object.keys(Pe);let Ce=Ve.find($=>/audio|wave|pcm/i.test($))||Ve[0];const ke=Pe[Ce];let _e=ke?.data;if(!_e)throw new Error("Model did not return audio tensor");let Ee=_e instanceof Float32Array?_e:Float32Array.from(_e);if((ke?.dims?.length||0)>1){const $=new Float32Array(ke.data.length);$.set(ke.data),Ee=$}let Me=n.targetSampleRate||24e3;const Le=Ve.find($=>/(sample|sampling).*rate|^sr$/i.test($));if(Le){const $=Pe[Le],B=Array.isArray($?.data)||$?.data?$.data[0]:null,q=Number(B);!Number.isNaN(q)&&q>8e3&&q<192e3&&(Me=q)}if(l())return;const nt=await Lt(Ee,Me,{audioContext:M,playbackRate:Math.max(.5,Math.min(n.rate||1,2)),onEnded:()=>{}});r(nt.stop);const st=Ee.length/Me/Math.max(.5,Math.min(n.rate||1,2));console.log(`[TTS] synthesized chunk: voice=${n.voice}, sr=${Me}, samples=${Ee.length}, durSec=${st.toFixed(2)}`),await new Promise($=>setTimeout($,Math.max(0,st*1e3)))};for(let O=0;O<S.length&&!(l()||(await X(S[O]),l()));O++){const te=n.interChunkPauseMs||0;te>0&&await new Promise(D=>setTimeout(D,te))}if(!l()){const O=performance.now();console.log(`[TTS] all chunks synthesized in ${(O-d).toFixed(0)}ms`)}K(O=>({...O,isPlaying:!1,isPaused:!1}));return}if("speechSynthesis"in window){await N().catch(()=>{}),await he();const f=speechSynthesis.getVoices();if(!f||f.length===0)throw new Error("No SpeechSynthesis voices available on this platform");await fe(S);const M=performance.now();console.log(`[TTS] all chunks spoken in ${(M-d).toFixed(0)}ms`),K(X=>({...X,isPlaying:!1,isPaused:!1}));return}if(!Q().model)throw new Error("No TTS available (load a model or enable SpeechSynthesis)")}catch(n){throw K(d=>({...d,isPlaying:!1,lastError:n?.message||"TTS error"})),n}},stop:()=>{h(!0),K(d=>({...d,isPlaying:!1,isPaused:!1}));const o=s();try{o&&o()}catch{}r(null);try{const d=w();d&&d()}catch{}if(j(null),k(null),y(!1),"speechSynthesis"in window)try{speechSynthesis.cancel()}catch{}const n=e();try{Vt(n)}catch{}t(null)},pause:()=>{let o=!1;if(Q().model?.name==="Piper TTS"&&Q().engine==="local"){const n=w();if(n)try{n()}catch{}o=!0}if("speechSynthesis"in window)try{speechSynthesis.pause(),o=!0}catch{}{const n=e();n&&Ft(n).then(()=>{}).catch(()=>{}),o=!0}o&&K(n=>({...n,isPaused:!0}))},resume:()=>{let o=!1;if(Q().model?.name==="Piper TTS"&&Q().engine==="local"){const n=Z();if(n)try{n()}catch{}o=!0}if("speechSynthesis"in window)try{speechSynthesis.resume(),o=!0}catch{}{const n=e();n&&At(n).then(()=>{}).catch(()=>{}),o=!0}o&&K(n=>({...n,isPaused:!1}))},setVoice:o=>{K(n=>({...n,voice:o}))},setRate:o=>{K(n=>({...n,rate:Math.max(.5,Math.min(o,2))}))},setPitch:o=>{K(n=>({...n,pitch:Math.max(.5,Math.min(o,2))}))},setChunkMaxChars:o=>{K(n=>({...n,chunkMaxChars:Math.max(64,Math.min(o||280,2e3))}))},setChunkOverlapChars:o=>{K(n=>({...n,chunkOverlapChars:Math.max(0,Math.min(o||0,200))}))},setSentenceSplit:o=>{K(n=>({...n,sentenceSplit:!!o}))},setInterChunkPauseMs:o=>{K(n=>({...n,interChunkPauseMs:Math.max(0,Math.min(o||0,2e3))}))},setTargetSampleRate:o=>{const n=Math.max(8e3,Math.min(o||24e3,192e3));K(d=>({...d,targetSampleRate:n}))}}};var Rt=le("<div class=pdf-page-container><canvas class=pdf-page-canvas></canvas><div class=pdf-text-layer>"),Dt=le("<div class=page-error>"),Ut=le("<div class=pdf-page-placeholder>");const It=e=>{const{state:t,getCurrentPage:s}=ft(),[r,l]=ue(null),[h,a]=ue(null),[i,b]=ue(null),[m,c]=ue(!1);let g=null,x=null,se=0,w=-1,j=!1,Z=0;const k=2,ie=globalThis.__pdfRenderWaiters||(globalThis.__pdfRenderWaiters=[]),y=globalThis.__pdfRenderInflight||(globalThis.__pdfRenderInflight={count:0}),U=async()=>{y.count>=k&&await new Promise(z=>ie.push(z)),y.count++},I=()=>{y.count=Math.max(0,y.count-1);const z=ie.shift();z&&z()},N=async()=>{const z=++Z;if(!r()||!e.isVisible){e.isVisible||console.log("[PDFPage] skip render page",e.pageNumber,"visible=false");return}console.info("[PDFPage] queue render page",e.pageNumber,"scale",e.scale),b(null),w=e.scale;try{if(await U(),z!==Z||!e.isVisible){console.log("[PDFPage] abort before start",e.pageNumber,"(invisible or superseded)");return}console.info("[PDFPage] start render page",e.pageNumber);const W=await s(e.pageNumber);if(!W){b("Page not found"),console.error("[PDFPage] page not found",e.pageNumber);return}const R=r(),P=R.getContext("2d");if(!P)return;const ee=W.getViewport({scale:e.scale});if(R.height=ee.height,R.width=ee.width,P.clearRect(0,0,R.width,R.height),g&&(g.cancel(),g=null),x&&typeof x.cancel=="function"){try{x.cancel()}catch{}x=null}const he={canvasContext:P,viewport:ee,enableWebGL:!1,renderInteractiveForms:!1};g=W.render(he),await g.promise,c(!0),se=e.scale,console.info("[PDFPage] finished render page",e.pageNumber);const fe=h();if(fe){fe.innerHTML="";const ge=await at(()=>import("./pdf_viewer-B-JNEIyA.js"),[]),{TextLayerBuilder:Se}=ge;x=new Se({pdfPage:W,onAppend:be=>{be.style.setProperty("--total-scale-factor",String(e.scale)),fe.appendChild(be)}}),await x.render({viewport:ee})}}catch(W){const R=W,P=R&&(R.name||R.message)||"",ee=P==="RenderingCancelledException"||P==="RenderingCancelled"||P==="AbortException"||typeof R?.message=="string"&&/cancel/i.test(R.message);ee||(b("Failed to render page"),console.error("Error rendering page:",R)),ee&&console.log("[PDFPage] canceled render page",e.pageNumber)}finally{g&&(g=null),I()}};return lt(()=>{console.info("[PDFPage] mount page",e.pageNumber),e.isVisible&&N()}),ht(()=>{e.pageNumber,e.scale;const z=e.isVisible,W=r(),R=j&&!z;if(j=!!z,R){if(Z++,g){try{g.cancel()}catch{}g=null}if(x&&typeof x.cancel=="function")try{x.cancel()}catch{}return}if(z&&W){const ee=!m(),he=Math.abs((e.scale||0)-(se||0))>.001,fe=Math.abs((e.scale||0)-(w||0))<=.001;(ee||he||!g&&!fe)&&N()}}),Ke(()=>{if(g&&g.cancel(),x&&typeof x.cancel=="function")try{x.cancel()}catch{}}),(()=>{var z=Rt(),W=z.firstChild,R=W.nextSibling;return v(z,(()=>{var P=de(()=>!!i());return()=>P()&&(()=>{var ee=Dt();return v(ee,i),ee})()})(),W),v(z,()=>{const P=t().pages[e.pageNumber-1];if(!P)return null;const ee=Math.max(1,Math.round(P.width*e.scale)),he=Math.max(1,Math.round(P.height*e.scale)),fe=!m();return(()=>{var ge=Ut();return ye(ge,"display",fe?"block":"none"),ye(ge,"width",`${ee}px`),ye(ge,"height",`${he}px`),ge})()},W),ot(l,W),ye(W,"height","auto"),ot(a,R),ve(P=>{var ee=e.pageNumber,he=i()||!m()?"none":"block",fe=e.fitWidth?"100%":"none",ge=i()||!m()?"none":"block";return ee!==P.e&&Oe(z,"data-page",P.e=ee),he!==P.t&&ye(W,"display",P.t=he),fe!==P.a&&ye(W,"max-width",P.a=fe),ge!==P.o&&ye(R,"display",P.o=ge),P},{e:void 0,t:void 0,a:void 0,o:void 0}),z})()};var Wt=le('<div><button class=icon-btn aria-label=Highlight title=Highlight><svg viewBox="0 0 24 24"width=18 height=18 fill=currentColor aria-hidden=true><path d="M3 16.5l4.5 4.5 3-3-4.5-4.5-3 3zm5.6-5.6l4.5 4.5L21 7.5 16.5 3 8.6 10.9zM15 6l3 3"></path></svg></button><button class=icon-btn aria-label=Bookmark title=Bookmark><svg viewBox="0 0 24 24"width=18 height=18 fill=currentColor aria-hidden=true><path d="M6 2h12a1 1 0 0 1 1 1v18l-7-4-7 4V3a1 1 0 0 1 1-1z"></path></svg></button><button class=icon-btn aria-label=Speak title=Speak><svg viewBox="0 0 24 24"width=18 height=18 fill=currentColor aria-hidden=true><path d="M4 9v6h4l5 4V5L8 9H4z"></path><path d="M16 8a5 5 0 0 1 0 8"fill=none stroke=currentColor stroke-width=2></path></svg></button><button class=icon-btn aria-label="Start Speech Here"title="Start Speech Here"><svg viewBox="0 0 24 24"width=18 height=18 fill=currentColor aria-hidden=true><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm-1.5 6.5l6 3.5-6 3.5v-7z">');function wt(e){let t=null;if(!e)return!1;for(e.nodeType===Node.ELEMENT_NODE?t=e:e.parentElement&&(t=e.parentElement);t;){if(t.classList?.contains("textLayer")||t.classList?.contains("pdf-text-layer"))return!0;t=t.parentElement}return!1}const Ot=()=>{const[e,t]=ue(!1),[s,r]=ue({top:0,left:0}),[l,h]=ue("above");let a=null;const{speak:i}=gt(),{state:b}=ft(),m=()=>{const w=window.getSelection();if(!w||w.isCollapsed||w.rangeCount===0){t(!1);return}const j=wt(w.anchorNode),Z=wt(w.focusNode);if(!j&&!Z){t(!1);return}let k=null;try{k=w.getRangeAt(0).getBoundingClientRect()}catch{k=null}if(!k||k.width===0&&k.height===0){t(!1);return}const ie=8,U=document.querySelector(".pdf-top-rail")?.offsetHeight??56,I=k.top,N=window.innerHeight-k.bottom;let z="above";I<U+16&&N>40?z="below":N<16&&I>N&&(z="above");const W=Math.min(window.innerWidth-8,Math.max(8,k.left+k.width/2));let R;z==="above"?R=Math.max(U+8,k.top-ie):R=Math.min(window.innerHeight-8,k.bottom+ie),h(z),r({top:R,left:W}),t(!0)};lt(()=>{document.addEventListener("selectionchange",m),window.addEventListener("resize",m),document.addEventListener("scroll",m,{passive:!0}),a=document.querySelector(".pdf-scroll"),a&&a.addEventListener("scroll",m,{passive:!0});const w=()=>setTimeout(m,0);document.addEventListener("mouseup",w),Ke(()=>{document.removeEventListener("mouseup",w)})}),Ke(()=>{document.removeEventListener("selectionchange",m),window.removeEventListener("resize",m),document.removeEventListener("scroll",m),a&&a.removeEventListener("scroll",m)});const c=()=>{const w=window.getSelection();if(!w||w.isCollapsed||w.rangeCount===0)return null;try{const j=w.getRangeAt(0),Z=w.toString();return{sel:w,range:j,text:Z}}catch{return null}},g=w=>{let j=w?.nodeType===Node.ELEMENT_NODE?w:w.parentElement;for(;j;){if(j.classList?.contains("pdf-page-container")){const Z=j.getAttribute("data-page");if(Z)return Number(Z)}j=j.parentElement}return null},x=async w=>{w.stopPropagation(),w.preventDefault();const Z=c()?.text?.trim();if(Z)try{await i(Z)}catch(k){console.error("Speak selection failed:",k)}},se=async w=>{w.stopPropagation(),w.preventDefault();const j=c(),Z=j?.text?.trim(),k=j?.range;if(!Z||!k)return;const ie=k.startContainer,y=g(ie);if(!y){try{await i(Z)}catch(P){console.error(P)}return}const U=b().pages,I=U[y-1]?.textContent||"";let N=0;const z=I.indexOf(Z);z>=0&&(N=z);const W=[];W.push(I.slice(N));for(let P=y;P<U.length;P++)W.push(U[P].textContent||"");const R=W.join(`

`).trim();if(R)try{await i(R)}catch(P){console.error("Start speech here failed:",P)}};return(()=>{var w=Wt(),j=w.firstChild,Z=j.nextSibling,k=Z.nextSibling,ie=k.nextSibling;return j.$$mousedown=y=>{y.preventDefault(),y.stopPropagation()},Z.$$mousedown=y=>{y.preventDefault(),y.stopPropagation()},k.$$mousedown=x,ie.$$mousedown=se,ve(y=>{var U="selection-toolbar"+(e()?"":" hidden")+` ${l()}`,I=`${s().top}px`,N=`${s().left}px`;return U!==y.e&&$e(w,y.e=U),I!==y.t&&ye(w,"top",y.t=I),N!==y.a&&ye(w,"left",y.a=N),y},{e:void 0,t:void 0,a:void 0}),w})()};ct(["mousedown"]);var Bt=le('<div class=pdf-viewer><div><select class=rail-select aria-label="Switch tab"><option value=pdf selected>PDF Viewer</option><option value=settings>Settings</option></select><input type=file accept=.pdf><button class=rail-btn>Open</button><div style=display:inline-flex;gap:6px;align-items:center><select class=rail-select aria-label="Select TTS model"><option value="Browser TTS">Browser TTS (System)</option></select><button></button><span class=rail-meta></span></div><div class=rail-meta></div></div><div class=pdf-scroll><div class=pdf-pages></div><div class=pdf-zoom-controls><button class=zoom-btn aria-label="Zoom out"title="Zoom out (-)">−</button><div class=zoom-display title="Reset to 100%"></div><button class=zoom-btn aria-label="Zoom in"title="Zoom in (+)">+</button><button></button><button class=zoom-btn>'),qt=le("<option>"),zt=le("<span> · <!> pages"),Gt=le("<span>No PDF loaded"),jt=le("<div class=loading>Loading PDF..."),Ht=le("<div class=error>"),Kt=le('<div class=placeholder-page><p>No PDF loaded</p><p>Click "Open" to select a file');const Zt=()=>{const{state:e,loadPDF:t,getAllExtractedText:s}=ft(),{state:r,speak:l,pause:h,resume:a,models:i,loadModel:b,ensureBrowserEngine:m}=gt(),[c,g]=ue("Kokoro TTS"),[x,se]=ue(null),[w,j]=ue(window.innerWidth),[Z,k]=ue(!0);let ie,y=null;const[U,I]=ue(new Set([1]));let N=null,z=0,W=!1;const R=new Set;let P=1,ee=1;const he=10,fe=()=>{I(ce=>{const G=new Set;for(let _=P;_<=ee;_++)G.add(_);if(R.forEach(_=>G.add(_)),G.size===0&&e().pages.length>0&&G.add(1),ce.size===G.size){let _=!0;for(const oe of ce)if(!G.has(oe)){_=!1;break}if(_)return ce}return console.info("[PDFViewer] visiblePages size ->",G.size,"pages:",Array.from(G).slice(0,10),G.size>10?"…":""),G})},[ge,Se]=ue(1),[be,Re]=ue(!1),Be=32,tt=ce=>{const _=ce.target.files?.[0];_&&_.type==="application/pdf"&&t(_)},Ae=ce=>{const G=e().pages[ce];if(!G)return 1;if(be()){const _=Math.max(100,w()-Be);return Math.max(.1,_/G.width)}return 1*ge()},De=()=>{j(window.innerWidth)},Te=()=>{k(!0),ie&&window.clearTimeout(ie),ie=window.setTimeout(()=>k(!1),2e3)};lt(()=>{window.addEventListener("resize",De),document.addEventListener("mousemove",Te),document.addEventListener("scroll",Te,{passive:!0}),ie=window.setTimeout(()=>k(!1),1500),(()=>{if(!y)return;N&&N.disconnect(),!W&&y&&(y.addEventListener("scroll",ze,{passive:!0}),W=!0,console.info("[PDFViewer] Attached scroll listener to .pdf-scroll")),console.info("[PDFViewer] Setting up IntersectionObserver"),N=new IntersectionObserver(oe=>{for(const o of oe){const n=o.target.getAttribute("data-page"),d=n?parseInt(n,10):NaN;Number.isFinite(d)&&(o.isIntersecting?(R.add(d),console.log("[PDFViewer] IO intersect add page",d)):(R.delete(d),console.log("[PDFViewer] IO intersect remove page",d)))}fe()},{root:y,rootMargin:"300px 0px",threshold:0});const _=()=>{if(!N)return;const oe=y.querySelectorAll(".pdf-page-container");console.info("[PDFViewer] Observing",oe.length,"page nodes"),oe.forEach(o=>N.observe(o))};requestAnimationFrame(()=>{_(),qe()})})();const G=_=>{const oe=_.target;if(oe&&(oe.tagName==="INPUT"||oe.tagName==="TEXTAREA"||oe.isContentEditable))return;const n=.1;if(_.key==="+"||_.key==="=")_.preventDefault(),Se(d=>Math.min(4,+(d+n).toFixed(2)));else if(_.key==="-"||_.key==="_")_.preventDefault(),Se(d=>Math.max(.25,+(d-n).toFixed(2)));else if(_.key==="0")_.preventDefault(),Se(1);else if(_.key.toLowerCase()==="f"){if(_.ctrlKey||_.metaKey||_.altKey||_.shiftKey)return;_.preventDefault(),Re(d=>!d)}};document.addEventListener("keydown",G),Ke(()=>document.removeEventListener("keydown",G))});const qe=()=>{try{if(!y)return;const ce=y.getBoundingClientRect(),G=Array.from(y.querySelectorAll(".pdf-page-container"));let _=null;for(const oe of G){const o=oe.getBoundingClientRect();if(o.bottom>=ce.top&&o.top<=ce.bottom){const d=oe.getAttribute("data-page"),S=d?parseInt(d,10):NaN;if(Number.isFinite(S)){_=S;break}}}if(!_){e().pages.length>0&&(console.info("[PDFViewer] seed: no intersecting pages; fallback to 1"),P=1,ee=1,fe());return}if(_===z)return;z=_,P=Math.max(1,_-he),ee=Math.min(e().pages.length,_+he),console.info("[PDFViewer] seed from scroll: center",_,"window",P," - ",ee),fe()}catch{}},ze=()=>{requestAnimationFrame(()=>qe())};return Ke(()=>{window.removeEventListener("resize",De),document.removeEventListener("mousemove",Te),document.removeEventListener("scroll",Te),ie&&window.clearTimeout(ie),N&&N.disconnect(),y&&y.removeEventListener("scroll",ze),W=!1}),ht(()=>{e().pages.length,Te(),y&&N&&(N.disconnect(),R.clear(),requestAnimationFrame(()=>{if(!N||!y)return;const ce=y.querySelectorAll(".pdf-page-container");ce.forEach(G=>N.observe(G)),console.info("[PDFViewer] Rebinding observer to",ce.length,"page nodes")}),requestAnimationFrame(()=>qe()),W||(y.addEventListener("scroll",ze,{passive:!0}),W=!0,console.info("[PDFViewer] Attached scroll listener to .pdf-scroll (rebinding)")))}),(()=>{var ce=Bt(),G=ce.firstChild,_=G.firstChild,oe=_.nextSibling,o=oe.nextSibling,n=o.nextSibling,d=n.firstChild;d.firstChild;var S=d.nextSibling,F=S.nextSibling,A=n.nextSibling,L=G.nextSibling,f=L.firstChild,M=f.nextSibling,X=M.firstChild,O=X.nextSibling,te=O.nextSibling,D=te.nextSibling,H=D.nextSibling;return _.addEventListener("change",u=>{const C=u.target.value;window.dispatchEvent(new CustomEvent("app:set-mode",{detail:C}))}),oe.addEventListener("change",tt),ot(se,oe),ye(oe,"display","none"),o.$$click=()=>x()?.click(),d.addEventListener("change",u=>g(u.target.value)),v(d,()=>i.map(u=>(()=>{var C=qt();return v(C,()=>u.name,null),v(C,()=>u.requiresWebGPU?" (WebGPU)":"",null),ve(()=>C.value=u.name),C})()),null),S.$$click=async()=>{try{c()==="Browser TTS"?await m():await b(c())}catch{}},v(S,(()=>{var u=de(()=>c()==="Browser TTS");return()=>u()?de(()=>r().engine==="browser")()?"Using":(r().systemVoices||[]).length===0&&r().lastError?"Error":"Use":de(()=>!!r().isModelLoading)()?"Loading…":r().model?.name===c()?"Loaded":"Load"})()),v(F,()=>r().isWebGPUSupported?"WebGPU ✓":"WebGPU ×"),v(A,(()=>{var u=de(()=>!!e().document);return()=>u()?(()=>{var C=zt(),Y=C.firstChild,V=Y.nextSibling;return V.nextSibling,v(C,()=>e().document?.title||"Untitled Document",Y),v(C,()=>e().pages.length,V),C})():Gt()})()),ot(u=>{y=u},L),v(L,(()=>{var u=de(()=>!!e().isLoading);return()=>u()&&jt()})(),f),v(L,(()=>{var u=de(()=>!!e().error);return()=>u()&&(()=>{var C=Ht();return v(C,()=>e().error),C})()})(),f),v(f,(()=>{var u=de(()=>!!e().document);return()=>u()?He($t,{get each(){return e().pages},children:(C,Y)=>He(It,{get pageNumber(){return C.pageNumber},get scale(){return Ae(Y())},get isVisible(){return U().has(C.pageNumber)},get fitWidth(){return be()}})}):Kt()})()),v(L,He(Ot,{}),M),X.$$click=()=>Se(u=>Math.max(.25,+(u-.1).toFixed(2))),O.$$click=()=>Se(1),v(O,()=>{if(be()&&e().pages.length>0){const u=e().pages[0],C=Math.max(100,w()-Be);return`${(Math.max(.1,C/u.width)*100).toFixed(0)}%`}return`${(ge()*100).toFixed(0)}%`}),te.$$click=()=>Se(u=>Math.min(4,+(u+.1).toFixed(2))),D.$$click=()=>Re(u=>!u),v(D,()=>be()?"Fit Width ✓":"Fit Width"),H.$$click=()=>{try{if(r().isPlaying)r().isPaused?a():h();else{const u=s();u&&u.trim()&&l(u)}}catch(u){console.error("TTS error:",u)}},v(H,()=>r().isPlaying?r().isPaused?"Resume":"Pause":"Play"),ve(u=>{var C="pdf-top-rail"+(Z()?"":" hidden"),Y="rail-btn"+(c()==="Browser TTS"&&"speechSynthesis"in window&&(r().systemVoices||[]).length===0&&r().lastError&&r().engine!=="browser"?" error":""),V=c()==="Browser TTS"?!("speechSynthesis"in window)||r().engine==="browser":r().isModelLoading||r().model?.name===c()||i.find(Le=>Le.name===c())?.requiresWebGPU&&!r().isWebGPUSupported,ne=c()==="Browser TTS"?"speechSynthesis"in window?r().engine==="browser"?"Using Browser TTS":(r().systemVoices||[]).length===0&&r().lastError?"No system voices found. Install a system speech backend.":"Use Browser TTS":"SpeechSynthesis unavailable":!r().isWebGPUSupported&&i.find(Le=>Le.name===c())?.requiresWebGPU?"WebGPU required":"Load TTS model",Pe=`WebGPU ${r().isWebGPUSupported?"supported":"not supported"}`,Ve="zoom-toggle"+(be()?" active":""),Ce=be(),ke=be()?"Disable fit width (F)":"Fit to width (F)",_e=r().isPlaying?r().isPaused?"Resume":"Pause":"Play",Ee=r().isPlaying?r().isPaused?"Resume reading":"Pause reading":"Play reading",Me=!e().document||!r().model&&!("speechSynthesis"in window);return C!==u.e&&$e(G,u.e=C),Y!==u.t&&$e(S,u.t=Y),V!==u.a&&(S.disabled=u.a=V),ne!==u.o&&Oe(S,"title",u.o=ne),Pe!==u.i&&Oe(F,"title",u.i=Pe),Ve!==u.n&&$e(D,u.n=Ve),Ce!==u.s&&Oe(D,"aria-pressed",u.s=Ce),ke!==u.h&&Oe(D,"title",u.h=ke),_e!==u.r&&Oe(H,"aria-label",u.r=_e),Ee!==u.d&&Oe(H,"title",u.d=Ee),Me!==u.l&&(H.disabled=u.l=Me),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0,l:void 0}),ve(()=>d.value=c()),ce})()};ct(["click"]);var Xt=le('<div class=settings-view-wrap><div class=settings-top-rail><select class=rail-select aria-label="Switch tab"><option value=pdf>PDF Viewer</option><option value=settings selected>Settings</option></select><div class=rail-meta>App Settings</div></div><div class=settings-scroll><div class=settings-view><h2>Settings</h2><div class=settings-section><h3>TTS Engine / Model</h3><div class=model-list><div class=model-item><div class=model-info><h4>Browser TTS (System)</h4><p>Uses built-in SpeechSynthesis voices</p><p>Voices: </p><p></p></div><div style=display:flex;gap:8px;align-items:center><button></button><button title="Force browser to load system voices"></button></div></div></div></div><div class=settings-section><h3>Voice Settings</h3><div class=voice-controls><label>Voice:</label><select></select></div></div><div class=settings-section><h3>TTS Chunking</h3><p class=hint>Controls how input text is split for inference/playback. Console logs include chunk indices and timing.</p><div class=voice-controls><label>Max chunk size:</label><input type=number min=64 max=2000 step=10><span> chars</span><label>Overlap:</label><input type=number min=0 max=200 step=1><span> chars</span><label>Split by sentence:</label><input type=checkbox><label>Pause between chunks:</label><input type=number min=0 max=2000 step=20><span> ms</span></div></div><div class=settings-section><h3>System Information</h3><div class=system-info><p><strong>WebGPU Status:</strong> </p><p><strong>Current Voice:</strong> </p><p><strong>Speech Rate:</strong> <!>x</p><p><strong>Speech Pitch:</strong> </p></div></div><div class=settings-section><h3>Audio</h3><div class=voice-controls><label>Target sample rate:</label><input type=number min=8000 max=192000 step=1000><span> Hz</span></div></div><div class=settings-section><h3>About</h3><div class=about-info><p><strong>PageSonic</strong> - Privacy-preserving PDF viewer with text-to-speech</p><p>Running entirely in your browser for maximum privacy</p><p>Features:</p><ul><li>Local PDF viewing with text extraction</li><li>Browser-based text-to-speech</li><li>No data sent to external servers</li><li>Works offline'),Yt=le("<p class=error>WebGPU not supported. Kokoro requires WebGPU; Piper can run on CPU."),Jt=le("<p class=error>"),Qt=le("<div class=model-item><div class=model-info><h4></h4><p>Size: <!>MB</p><p>Voices: </p><p>WebGPU Required: </p><p></p></div><button>"),en=le("<option>"),tn=le("<p><strong>Loaded Model:</strong> "),nn=le('<div class=voice-metadata style="margin-top:1rem;padding-top:1rem;border-top:1px solid #ccc"><h4 style=margin-bottom:0.5rem>Voice Details</h4><p><strong>Display Name:</strong> </p><p><strong>Description:</strong> </p><p><strong>Gender:</strong> </p><p><strong>Accent:</strong> </p><p><strong>Subset:</strong> '),sn=le("<p><strong>Avg Pitch:</strong> <!> Hz"),on=le("<p><strong>Speaking Rate:</strong> <!> wpm"),rn=le("<p><strong>Brightness:</strong> ");const an=()=>{const{state:e,models:t,loadModel:s,setVoice:r,ensureBrowserEngine:l,primeSystemVoices:h,refreshSystemVoices:a,setChunkMaxChars:i,setChunkOverlapChars:b,setSentenceSplit:m,setInterChunkPauseMs:c,setTargetSampleRate:g}=gt(),[x,se]=ue(!1),[w,j]=ue(null),Z=async U=>{try{await s(U)}catch(I){console.error("Failed to load model:",I)}};ht(async()=>{try{const U=await fetch("/tts-model/voices.json");if(U.ok){const I=await U.json();j(I)}}catch(U){console.warn("Failed to load voice metadata:",U)}});const k=()=>{const U=e().voice;if(!U||!w())return null;const I=w()["en_US-libritts_r-medium"];return!I||!I.speakers?null:I.speakers.find(N=>N.speaker_id===U)},ie=U=>!(U.requiresWebGPU&&!e().isWebGPUSupported),y=U=>ie(U)?e().model?.name===U.name?{status:"loaded",message:"Currently loaded"}:{status:"available",message:"Available to load"}:{status:"incompatible",message:"WebGPU required but not supported"};return(()=>{var U=Xt(),I=U.firstChild,N=I.firstChild,z=I.nextSibling,W=z.firstChild,R=W.firstChild,P=R.nextSibling,ee=P.firstChild,he=ee.nextSibling,fe=he.firstChild,ge=fe.firstChild,Se=ge.firstChild,be=Se.nextSibling,Re=be.nextSibling;Re.firstChild;var Be=Re.nextSibling,tt=ge.nextSibling,Ae=tt.firstChild,De=Ae.nextSibling,Te=P.nextSibling,qe=Te.firstChild,ze=qe.nextSibling,ce=ze.firstChild,G=ce.nextSibling,_=Te.nextSibling,oe=_.firstChild,o=oe.nextSibling,n=o.nextSibling,d=n.firstChild,S=d.nextSibling,F=S.nextSibling,A=F.firstChild,L=F.nextSibling,f=L.nextSibling,M=f.nextSibling,X=M.firstChild,O=M.nextSibling,te=O.nextSibling,D=te.nextSibling,H=D.nextSibling,u=H.nextSibling,C=u.firstChild,Y=_.nextSibling,V=Y.firstChild,ne=V.nextSibling,Pe=ne.firstChild,Ve=Pe.firstChild;Ve.nextSibling;var Ce=Pe.nextSibling,ke=Ce.firstChild;ke.nextSibling;var _e=Ce.nextSibling,Ee=_e.firstChild,Me=Ee.nextSibling,Le=Me.nextSibling;Le.nextSibling;var nt=_e.nextSibling,st=nt.firstChild;st.nextSibling;var $=Y.nextSibling,B=$.firstChild,q=B.nextSibling,pe=q.firstChild,J=pe.nextSibling,T=J.nextSibling,re=T.firstChild;return N.addEventListener("change",p=>{const E=p.target.value;window.dispatchEvent(new CustomEvent("app:set-mode",{detail:E}))}),v(P,(()=>{var p=de(()=>!e().isWebGPUSupported);return()=>p()&&(()=>{var E=Yt();return ye(E,"padding","0.5rem 0.75rem"),ye(E,"margin","0 0 0.75rem 0"),E})()})(),he),v(P,(()=>{var p=de(()=>!!e().lastError);return()=>p()&&(()=>{var E=Jt();return ye(E,"padding","0.5rem 0.75rem"),ye(E,"margin","0 0 0.75rem 0"),v(E,()=>e().lastError),E})()})(),he),v(Re,(()=>{var p=de(()=>(e().systemVoices||[]).length>0);return()=>p()?(e().systemVoices||[]).join(", "):"none detected"})(),null),v(Be,(()=>{var p=de(()=>e().engine==="browser");return()=>p()?"Currently in use":(e().systemVoices||[]).length>0?"Available":"Unavailable (no voices). A system speech backend must be installed."})()),Ae.$$click=async()=>{await l()},v(Ae,()=>e().engine==="browser"?"Using":"Use"),De.$$click=async()=>{try{se(!0),await h(6e3),a()}finally{se(!1)}},v(De,()=>x()?"Refreshing…":"Refresh voices"),v(he,()=>t.map(p=>{const E=y(p),ae=e().model?.name===p.name;return(()=>{var me=Qt(),Ue=me.firstChild,Fe=Ue.firstChild,Ze=Fe.nextSibling,Xe=Ze.firstChild,it=Xe.nextSibling;it.nextSibling;var Ie=Ze.nextSibling;Ie.firstChild;var Ye=Ie.nextSibling;Ye.firstChild;var Je=Ye.nextSibling,Ge=Ue.nextSibling;return v(Fe,()=>p.name),v(Ze,()=>p.size,it),v(Ie,()=>p.voices.join(", "),null),v(Ye,()=>p.requiresWebGPU?"Yes":"No",null),v(Je,()=>E.message),Ge.$$click=()=>Z(p.name),$e(Ge,ae?"loaded":""),v(Ge,()=>e().isModelLoading?"Loading...":ae?"Loaded":"Load Model"),ve(xe=>{var we=`status ${E.status}`,Ne=e().isModelLoading||!ie(p)||ae;return we!==xe.e&&$e(Je,xe.e=we),Ne!==xe.t&&(Ge.disabled=xe.t=Ne),xe},{e:void 0,t:void 0}),me})()}),null),G.addEventListener("change",p=>{const E=p.target;(e().model||e().engine==="browser")&&r(E.value)}),v(G,()=>(e().engine==="browser"?e().systemVoices||[]:e().model?.voices||[]).map(p=>(()=>{var E=en();return E.value=p,v(E,p),E})())),S.$$input=p=>i(parseInt(p.target.value||"280")),v(F,()=>e().chunkMaxChars,A),f.$$input=p=>b(parseInt(p.target.value||"0")),v(M,()=>e().chunkOverlapChars,X),te.addEventListener("change",p=>m(p.target.checked)),H.$$input=p=>c(parseInt(p.target.value||"0")),v(u,()=>e().interChunkPauseMs,C),v(Pe,()=>e().isWebGPUSupported?"Supported":"Not Supported",null),v(ne,(()=>{var p=de(()=>!!e().model);return()=>p()&&(()=>{var E=tn(),ae=E.firstChild;return ae.nextSibling,v(E,()=>e().model.name,null),E})()})(),Ce),v(Ce,()=>{if(e().engine==="browser"&&typeof window<"u"&&"speechSynthesis"in window){const p=window.speechSynthesis.getVoices(),E=(e().voice||"").toLowerCase();return(p.find(me=>me.name.toLowerCase()===E)||p.find(me=>me.name.toLowerCase().includes(E)))?.name||e().voice}return e().voice},null),v(_e,()=>e().rate.toFixed(1),Le),v(nt,()=>e().pitch.toFixed(1),null),v(ne,(()=>{var p=de(()=>!!(e().engine!=="browser"&&k()));return()=>p()&&(()=>{var E=nn(),ae=E.firstChild,me=ae.nextSibling,Ue=me.firstChild;Ue.nextSibling;var Fe=me.nextSibling,Ze=Fe.firstChild;Ze.nextSibling;var Xe=Fe.nextSibling,it=Xe.firstChild;it.nextSibling;var Ie=Xe.nextSibling,Ye=Ie.firstChild;Ye.nextSibling;var Je=Ie.nextSibling,Ge=Je.firstChild;return Ge.nextSibling,v(me,()=>k()?.display_name||"N/A",null),v(Fe,()=>k()?.description||"N/A",null),v(Xe,()=>k()?.gender||"N/A",null),v(Ie,()=>k()?.accent||"N/A",null),v(Je,()=>k()?.subset||"N/A",null),v(E,(()=>{var xe=de(()=>!!k()?.pitch_mean);return()=>xe()&&(()=>{var we=sn(),Ne=we.firstChild,dt=Ne.nextSibling,Qe=dt.nextSibling;return Qe.nextSibling,v(we,()=>Math.round(k().pitch_mean),Qe),we})()})(),null),v(E,(()=>{var xe=de(()=>!!k()?.speaking_rate);return()=>xe()&&(()=>{var we=on(),Ne=we.firstChild,dt=Ne.nextSibling,Qe=dt.nextSibling;return Qe.nextSibling,v(we,()=>Math.round(k().speaking_rate),Qe),we})()})(),null),v(E,(()=>{var xe=de(()=>!!k()?.brightness);return()=>xe()&&(()=>{var we=rn(),Ne=we.firstChild;return Ne.nextSibling,v(we,()=>k().brightness.toFixed(2),null),we})()})(),null),E})()})(),null),J.$$input=p=>g(parseInt(p.target.value||"24000")),v(T,()=>e().targetSampleRate,re),ve(p=>{var E=`status ${e().engine==="browser"?"loaded":(e().systemVoices||[]).length>0?"available":"incompatible"}`,ae=e().engine==="browser"||(e().systemVoices||[]).length===0,me=e().engine==="browser"?"loaded":"",Ue=x(),Fe=!e().model&&e().engine!=="browser"||e().engine==="browser"&&(e().systemVoices||[]).length===0;return E!==p.e&&$e(Be,p.e=E),ae!==p.t&&(Ae.disabled=p.t=ae),me!==p.a&&$e(Ae,p.a=me),Ue!==p.o&&(De.disabled=p.o=Ue),Fe!==p.i&&(G.disabled=p.i=Fe),p},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0}),ve(()=>G.value=e().voice),ve(()=>S.value=e().chunkMaxChars),ve(()=>f.value=e().chunkOverlapChars),ve(()=>te.checked=!!e().sentenceSplit),ve(()=>H.value=e().interChunkPauseMs),ve(()=>J.value=e().targetSampleRate),U})()};ct(["click","input"]);var ln=le("<div><header class=app-header><h1>PageSonic</h1><p>PDF Reader with Text-to-Speech</p><nav class=app-nav><button>PDF Viewer</button><button>Settings</button></nav></header><main class=app-main>");const cn=()=>{const[e,t]=ue("pdf");return lt(()=>{const s=r=>{const l=r.detail;(l==="pdf"||l==="settings")&&t(l)};window.addEventListener("app:set-mode",s),Ke(()=>window.removeEventListener("app:set-mode",s))}),(()=>{var s=ln(),r=s.firstChild,l=r.firstChild,h=l.nextSibling,a=h.nextSibling,i=a.firstChild,b=i.nextSibling,m=r.nextSibling;return i.$$click=()=>t("pdf"),b.$$click=()=>t("settings"),v(m,(()=>{var c=de(()=>e()==="pdf");return()=>c()&&He(Zt,{})})(),null),v(m,(()=>{var c=de(()=>e()==="settings");return()=>c()&&He(an,{})})(),null),ve(c=>{var g="app "+(e()==="pdf"?"app--pdf":"app--settings"),x=e()==="pdf"?"active":"",se=e()==="settings"?"active":"";return g!==c.e&&$e(s,c.e=g),x!==c.t&&$e(i,c.t=x),se!==c.a&&$e(b,c.a=se),c},{e:void 0,t:void 0,a:void 0}),s})()};ct(["click"]);Tt(()=>He(cn,{}),document.getElementById("root"));
